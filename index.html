</option>';
            loaders.forEach(loader => {
                select.innerHTML += `<option value="${loader}">${loader}</option>`;
            });
        }

        function filterReport() {
            const loaderFilter = document.getElementById('filterLoader').value;
            
            let data = reportData;
            if (loaderFilter) data = data.filter(e => e.dutyName === loaderFilter);

            if (selectedFilterStartDate && selectedFilterEndDate) {
                const start = new Date(selectedFilterStartDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(selectedFilterEndDate);
                end.setHours(23, 59, 59, 999);
                
                data = data.filter(e => {
                    const entryDate = new Date(e.date);
                    return entryDate >= start && entryDate <= end;
                });

                document.getElementById('filterInfo').style.display = 'flex';
                document.getElementById('filterRangeDisplay').textContent = 
                    `${formatDateDisplay(selectedFilterStartDate)} → ${formatDateDisplay(selectedFilterEndDate)}`;
                document.getElementById('filterCountDisplay').textContent = data.length;
            } else if (selectedFilterStartDate || selectedFilterEndDate) {
                const filterDate = selectedFilterStartDate || selectedFilterEndDate;
                data = data.filter(e => {
                    const entryDate = new Date(e.date).toDateString();
                    return entryDate === filterDate.toDateString();
                });
                
                document.getElementById('filterInfo').style.display = 'flex';
                document.getElementById('filterRangeDisplay').textContent = formatDateDisplay(filterDate);
                document.getElementById('filterCountDisplay').textContent = data.length;
            } else {
                document.getElementById('filterInfo').style.display = 'none';
            }

            data.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                return (SHIFT_ORDER[a.shift] || 0) - (SHIFT_ORDER[b.shift] || 0);
            });

            filteredData = data;
            updateReportTable();
        }

        function updateReportTable() {
            const tbody = document.getElementById('reportBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: var(--text-muted); padding: 2rem;">No entries found</td></tr>`;
                return;
            }

            let html = '';
            let totals = { active: 0, end: 0, cfr: 0, remit: 0, unremit: 0 };

            filteredData.forEach(entry => {
                totals.active += entry.activeChipsTotal || 0;
                totals.end += entry.endChipsTotal || 0;
                totals.cfr += entry.cfr || 0;
                totals.remit += entry.totalRemittances || 0;
                totals.unremit += entry.unremitted || 0;

                html += `<tr>
                    <td>${formatDateDisplay(entry.date)}</td>
                    <td style="font-size: 0.7rem;">${entry.shift || '-'}</td>
                    <td>${entry.dutyName || '-'}</td>
                    <td>${formatCurrency(entry.activeChipsTotal)}</td>
                    <td>${formatCurrency(entry.endChipsTotal)}</td>
                    <td>${formatCurrency(entry.cfr)}</td>
                    <td>${formatCurrency(entry.totalRemittances)}</td>
                    <td>${formatCurrency(entry.bankFee)}</td>
                    <td style="color: ${(entry.unremitted || 0) < 0 ? 'var(--accent-danger)' : 'var(--accent-warning)'};">${formatCurrency(entry.unremitted)}</td>
                    <td>${entry.remarks || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;" onclick="openEditModal(${entry.rowIndex})">✏️ Edit</button>
                    </td>
                </tr>`;
            });

            html += `<tr class="table-footer">
                <td colspan="3" style="text-align: right; font-weight: 600;">TOTALS:</td>
                <td>${formatCurrency(totals.active)}</td>
                <td>${formatCurrency(totals.end)}</td>
                <td>${formatCurrency(totals.cfr)}</td>
                <td>${formatCurrency(totals.remit)}</td>
                <td>-</td>
                <td style="color: ${totals.unremit < 0 ? 'var(--accent-danger)' : 'var(--accent-primary)'};">${formatCurrency(totals.unremit)}</td>
                <td colspan="2"></td>
            </tr>`;

            tbody.innerHTML = html;
        }

        function formatDateDisplay(dateInput) {
            if (!dateInput) return '-';
            const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
            return date.toLocaleDateString('en-US', { timeZone: CONFIG.timezone, month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ========== EDIT / DELETE ==========
        function setupEditForm() {
            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editingRowIndex) return;
                
                const data = {
                    action: 'updateEntry',
                    rowIndex: editingRowIndex,
                    date: document.getElementById('editDate').value,
                    shift: document.getElementById('editShift').value,
                    dutyName: document.getElementById('editDutyName').value,
                    activeChipsTotal: parseFloat(document.getElementById('editActiveChips').value) || 0,
                    endChipsTotal: parseFloat(document.getElementById('editEndChips').value) || 0,
                    cfr: parseFloat(document.getElementById('editCFR').value) || 0,
                    remittanceTotal: parseFloat(document.getElementById('editRemittance').value) || 0,
                    bankFee: parseFloat(document.getElementById('editBankFee').value) || 0,
                    salary: parseFloat(document.getElementById('editSalary').value) || 0,
                    totalRemittances: parseFloat(document.getElementById('editRemittance').value) + parseFloat(document.getElementById('editSalary').value) || 0,
                    unremitted: parseFloat(document.getElementById('editUnremitted').value) || 0,
                    remarks: document.getElementById('editRemarks').value
                };

                try {
                    await fetch(CONFIG.scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    showToast('Entry updated!', 'success');
                    closeEditModal();
                    refreshData();
                } catch (error) {
                    showToast('Failed to update: ' + error.message, 'error');
                }
            });
        }

        function openEditModal(rowIndex) {
            editingRowIndex = rowIndex;
            editingEntry = reportData.find(e => e.rowIndex === rowIndex);
            
            if (!editingEntry) { showToast('Entry not found', 'error'); return; }

            document.getElementById('editRowIndex').value = rowIndex;
            document.getElementById('editDate').value = editingEntry.date;
            document.getElementById('editShift').value = editingEntry.shift || '';
            document.getElementById('editDutyName').value = editingEntry.dutyName || '';
            document.getElementById('editActiveChips').value = editingEntry.activeChipsTotal || 0;
            document.getElementById('editEndChips').value = editingEntry.endChipsTotal || 0;
            document.getElementById('editCFR').value = editingEntry.cfr || 0;
            document.getElementById('editRemittance').value = editingEntry.remittanceTotal || 0;
            document.getElementById('editBankFee').value = editingEntry.bankFee || 0;
            document.getElementById('editSalary').value = editingEntry.salary || 0;
            document.getElementById('editUnremitted').value = editingEntry.unremitted || 0;
            document.getElementById('editRemarks').value = editingEntry.remarks || '';

            document.getElementById('editModal').classList.add('show');
        }

        function recalculateEdit() {
            const active = parseFloat(document.getElementById('editActiveChips').value) || 0;
            const end = parseFloat(document.getElementById('editEndChips').value) || 0;
            const remit = parseFloat(document.getElementById('editRemittance').value) || 0;
            const salary = parseFloat(document.getElementById('editSalary').value) || 0;

            document.getElementById('editCFR').value = (active - end).toFixed(5);
            document.getElementById('editUnremitted').value = ((remit + salary) - (active - end)).toFixed(5);
        }

        function closeEditModal() { editingRowIndex = null; editingEntry = null; document.getElementById('editModal').classList.remove('show'); }
        function openDeleteModal(rowIndex) { editingRowIndex = rowIndex; document.getElementById('deleteModal').classList.add('show'); }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('show'); }
        function deleteEntry() { closeEditModal(); openDeleteModal(editingRowIndex); }

        async function confirmDelete() {
            if (!editingRowIndex) return;
            
            try {
                await fetch(CONFIG.scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'deleteEntry', rowIndex: editingRowIndex }) });
                showToast('Entry deleted!', 'success');
                closeDeleteModal();
                editingRowIndex = null;
                refreshData();
            } catch (error) {
                showToast('Failed to delete: ' + error.message, 'error');
            }
        }

        // ========== EXPORT AS IMAGE ==========
        async function exportReportAsImage() {
            if (filteredData.length === 0) { showToast('No data to export', 'error'); return; }

            showToast('Generating image...', 'success');

            const canvas = document.getElementById('exportCanvas');
            const ctx = canvas.getContext('2d');

            const padding = 40, rowHeight = 35, headerHeight = 50, titleHeight = 80;
            const cols = [80, 120, 60, 100, 100, 100, 100, 60, 100, 70];
            const totalWidth = cols.reduce((a, b) => a + b, 0) + padding * 2;
            const totalHeight = titleHeight + headerHeight + (filteredData.length + 1) * rowHeight + padding * 2;

            canvas.width = totalWidth;
            canvas.height = totalHeight;

            ctx.fillStyle = '#0a0f1a';
            ctx.fillRect(0, 0, totalWidth, totalHeight);

            ctx.fillStyle = '#00d4ff';
            ctx.font = 'bold 20px Outfit, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('WackyBuds CFR Report', totalWidth / 2, padding + 25);

            ctx.fillStyle = '#64748b';
            ctx.font = '10px Outfit, sans-serif';
            ctx.fillText(`Timezone: ${TIMEZONE_INFO[CONFIG.timezone].name}`, totalWidth / 2, padding + 42);

            if (selectedFilterStartDate && selectedFilterEndDate) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '12px Outfit, sans-serif';
                ctx.fillText(`${formatDateDisplay(selectedFilterStartDate)} → ${formatDateDisplay(selectedFilterEndDate)}`, totalWidth / 2, padding + 58);
            }

            const headers = ['Date', 'Shift', 'Loader', 'Active', 'End', 'CFR', 'Remit', 'Fee', 'Unremit', 'Status'];
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(padding, padding + titleHeight, totalWidth - padding * 2, headerHeight);

            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 10px JetBrains Mono, monospace';
            ctx.textAlign = 'left';

            let x = padding + 10;
            headers.forEach((header, i) => { ctx.fillText(header.toUpperCase(), x, padding + titleHeight + 30); x += cols[i]; });

            let y = padding + titleHeight + headerHeight;
            let totals = { active: 0, end: 0, cfr: 0, remit: 0, unremit: 0 };

            filteredData.forEach((entry, idx) => {
                if (idx % 2 === 0) { ctx.fillStyle = '#111827'; ctx.fillRect(padding, y, totalWidth - padding * 2, rowHeight); }

                totals.active += entry.activeChipsTotal || 0;
                totals.end += entry.endChipsTotal || 0;
                totals.cfr += entry.cfr || 0;
                totals.remit += entry.totalRemittances || 0;
                totals.unremit += entry.unremitted || 0;

                ctx.font = '10px JetBrains Mono, monospace';
                x = padding + 10;
                const rowData = [formatDateDisplay(entry.date), (entry.shift || '-').substring(0, 15), entry.dutyName || '-', formatNumber(entry.activeChipsTotal), formatNumber(entry.endChipsTotal), formatNumber(entry.cfr), formatNumber(entry.totalRemittances), formatNumber(entry.bankFee), formatNumber(entry.unremitted), entry.remarks || '-'];

                rowData.forEach((val, i) => {
                    ctx.fillStyle = (i === 8 && (entry.unremitted || 0) < 0) ? '#ef4444' : '#f1f5f9';
                    ctx.fillText(String(val).substring(0, 12), x, y + 22);
                    x += cols[i];
                });

                y += rowHeight;
            });

            ctx.fillStyle = '#1e293b';
            ctx.fillRect(padding, y, totalWidth - padding * 2, rowHeight);
            ctx.font = 'bold 10px JetBrains Mono, monospace';

            x = padding + 10;
            const totalRow = ['TOTAL', '', '', formatNumber(totals.active), formatNumber(totals.end), formatNumber(totals.cfr), formatNumber(totals.remit), '-', formatNumber(totals.unremit), ''];

            totalRow.forEach((val, i) => {
                ctx.fillStyle = (i === 8 && totals.unremit < 0) ? '#ef4444' : '#00d4ff';
                ctx.fillText(val, x, y + 22);
                x += cols[i];
            });

            const link = document.createElement('a');
            link.download = `CFR_Report_${getDateStringInTimezone(new Date())}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            showToast('Image exported!', 'success');
        }

        // ========== HISTORY ==========
        async function loadHistory() {
            if (!CONFIG.scriptUrl) return;

            try {
                const response = await fetch(`${CONFIG.scriptUrl}?action=getHistory&_=${Date.now()}`);
                const data = await response.json();
                
                const tbody = document.getElementById('historyBody');
                if (!data.success || !data.history?.length) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 2rem;">No history</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.history.slice(0, 50).map(h => `
                    <tr>
                        <td>${h.timestamp || '-'}</td>
                        <td>${h.user || '-'}</td>
                        <td>${h.action || '-'}</td>
                        <td style="font-size: 0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${h.details || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('History error:', error);
            }
        }

        // ========== SETTINGS ==========
        function saveSettings() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (url) {
                CONFIG.scriptUrl = url;
                localStorage.setItem('cfr_script_url', url);
                showToast('Settings saved!', 'success');
                refreshData();
            } else {
                showToast('Please enter a valid URL', 'error');
            }
        }

        async function testConnection() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) { showToast('Enter URL first', 'error'); return; }
            if (!isOnline) { showToast('You are offline', 'error'); return; }

            try {
                const response = await fetch(`${url}?action=test&_=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) { showToast('Connection successful!', 'success'); updateConnectionStatus(true); }
                else { showToast('Connection failed', 'error'); updateConnectionStatus(false); }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                updateConnectionStatus(false);
            }
        }

        function clearLocalData() {
            if (confirm('Are you sure you want to clear all local data? This will reset settings and filters.')) {
                localStorage.removeItem('cfr_script_url');
                localStorage.removeItem('cfr_timezone');
                localStorage.removeItem('cfr_last_end_chips');
                localStorage.removeItem('cfr_filter_start');
                localStorage.removeItem('cfr_filter_end');
                showToast('Local data cleared!', 'success');
                location.reload();
            }
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (!isOnline) {
                dot.classList.add('offline');
                dot.classList.remove('connected');
                text.textContent = 'Offline';
            } else {
                dot.classList.remove('offline');
                dot.classList.toggle('connected', connected);
                text.textContent = connected ? 'Connected' : (CONFIG.scriptUrl ? 'Disconnected' : 'Not configured');
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '✅' : '❌'}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // ========== PWA ==========
        function setupPWA() {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.log);

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installPrompt').classList.add('show');
            });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => { deferredPrompt = null; dismissInstall(); });
            }
        }

        function dismissInstall() { document.getElementById('installPrompt').classList.remove('show'); }
    </script>
</body>
</html>
