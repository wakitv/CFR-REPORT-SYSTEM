<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WackyBuds CFR</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
:root{--bg:#0a0f1a;--bg2:#111827;--card:#141c2b;--input:#0d1320;--cyan:#00d4ff;--purple:#a855f7;--green:#10b981;--yellow:#f59e0b;--red:#ef4444;--text:#f1f5f9;--muted:#64748b;--border:#1e293b}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Outfit,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;-webkit-tap-highlight-color:transparent}
.header{background:rgba(17,24,39,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:.75rem 1rem;position:sticky;top:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:.5rem}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--cyan),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700}
.logo-text{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:.6rem;color:var(--muted);letter-spacing:1px}
.clock{text-align:center;font-family:'JetBrains Mono',monospace}
.clock-time{font-size:1.1rem;color:var(--cyan)}
.clock-date{font-size:.65rem;color:var(--muted)}
.status{display:flex;align-items:center;gap:.4rem;padding:.4rem .8rem;background:var(--input);border-radius:50px;font-size:.75rem}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--yellow)}
.status-dot.on{background:var(--green)}
.status-dot.off{background:var(--red)}
.badge{background:var(--yellow);color:#000;font-size:.65rem;padding:.1rem .4rem;border-radius:50px;font-weight:600}
.main{max-width:1400px;margin:0 auto;padding:1rem}
.tabs{display:flex;gap:.4rem;margin-bottom:1rem;overflow-x:auto}
.tab{padding:.6rem 1.2rem;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--muted);font-weight:500;cursor:pointer;white-space:nowrap;font-size:.85rem;border:none}
.tab.active{background:linear-gradient(135deg,var(--cyan),var(--purple));color:var(--bg)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1rem;margin-bottom:1rem}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border)}
.card-title{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:.5rem}
.card-total{font-family:'JetBrains Mono',monospace;color:var(--cyan);font-weight:600}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-bottom:1rem}
.stat{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:.75rem;text-align:center}
.stat-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--cyan)}
.stat-val.green{color:var(--green)}
.stat-val.yellow{color:var(--yellow)}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}
.form-group{display:flex;flex-direction:column;gap:.3rem}
.form-label{font-size:.8rem;color:var(--muted)}
.form-label.req::after{content:' *';color:var(--red)}
.form-input,.form-select{background:var(--input);border:1px solid var(--border);border-radius:10px;padding:.75rem;color:var(--text);font-family:inherit;font-size:.9rem;width:100%}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--cyan)}
.form-input.err{border-color:var(--red)}
.form-err{font-size:.7rem;color:var(--red);display:none}
.form-err.show{display:block}
.btn{padding:.75rem 1.25rem;border-radius:10px;font-weight:600;font-size:.9rem;cursor:pointer;border:none;font-family:inherit;display:inline-flex;align-items:center;justify-content:center;gap:.4rem}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--cyan),var(--purple));color:var(--bg)}
.btn-green{background:linear-gradient(135deg,var(--green),#059669);color:#fff}
.btn-secondary{background:var(--bg2);border:1px solid var(--border);color:var(--text)}
.btn-danger{background:linear-gradient(135deg,var(--red),#dc2626);color:#fff}
.btn-warning{background:linear-gradient(135deg,var(--yellow),#d97706);color:#000}
.btn-group{display:flex;gap:.5rem;flex-wrap:wrap}
.entry-list{display:flex;flex-direction:column;gap:.5rem}
.entry-row{display:grid;grid-template-columns:1fr 1fr auto;gap:.4rem;align-items:center}
.entry-input{background:var(--input);border:1px solid var(--border);border-radius:8px;padding:.6rem;color:var(--text);font-size:.85rem;width:100%}
.entry-input:focus{outline:none;border-color:var(--cyan)}
.btn-add{background:var(--input);border:1px dashed var(--border);border-radius:8px;padding:.6rem;color:var(--muted);font-size:.8rem;cursor:pointer;width:100%;text-align:center}
.btn-remove{background:rgba(239,68,68,.1);border:none;border-radius:6px;width:32px;height:32px;color:var(--red);cursor:pointer;font-size:1.1rem}
.calc-card{background:linear-gradient(135deg,rgba(0,212,255,.05),rgba(168,85,247,.05));border:1px solid var(--border);border-radius:12px;padding:1rem;margin-top:1rem}
.calc-row{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid var(--border)}
.calc-row:last-child{border-bottom:none}
.calc-label{color:var(--muted);font-size:.85rem}
.calc-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--cyan)}
.calc-val.big{font-size:1.2rem;color:var(--green)}
.calc-val.neg{color:var(--red)}
.tab-content{display:none}
.tab-content.active{display:block}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:800px}
th,td{padding:.6rem .5rem;text-align:left;border-bottom:1px solid var(--border)}
th{background:var(--bg2);color:var(--muted);font-weight:600;font-size:.7rem;text-transform:uppercase;position:sticky;top:0}
td{font-family:'JetBrains Mono',monospace;font-size:.8rem}
tr:hover{background:var(--input)}
tr.pending{background:rgba(245,158,11,.1);border-left:3px solid var(--yellow)}
.table-foot td{background:var(--bg2);font-weight:600;color:var(--cyan)}
.filter-row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:.75rem}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.25rem;width:100%;max-width:500px;max-height:90dvh;overflow-y:auto}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border)}
.modal-title{font-size:1.1rem;font-weight:600}
.modal-close{background:var(--input);border:none;border-radius:8px;width:36px;height:36px;color:var(--muted);cursor:pointer;font-size:1.3rem}
.toast-container{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:2000;display:flex;flex-direction:column;gap:.4rem;width:90%;max-width:350px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.75rem 1rem;display:flex;align-items:center;gap:.5rem;animation:toastIn .3s ease}
.toast.success{border-color:var(--green)}
.toast.error{border-color:var(--red)}
@keyframes toastIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
.loading-logo{width:60px;height:60px;background:linear-gradient(135deg,var(--cyan),var(--purple));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;margin-bottom:1rem}
.spinner{width:18px;height:18px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.offline-banner{display:none;background:linear-gradient(135deg,var(--yellow),#d97706);color:#000;text-align:center;padding:.4rem;font-size:.8rem;font-weight:600}
.offline-banner.show{display:block}
.sync-banner{display:none;background:linear-gradient(135deg,var(--cyan),var(--purple));color:#000;text-align:center;padding:.4rem;font-size:.8rem;font-weight:600}
.sync-banner.show{display:flex;align-items:center;justify-content:center;gap:.4rem}
.settings-group{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:.75rem}
.settings-title{font-weight:600;margin-bottom:.75rem}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid var(--border);gap:.75rem}
.settings-item:last-child{border-bottom:none}
.calendar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none}
.calendar-overlay.show{display:block}
.calendar-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:.75rem;z-index:1001;display:none;width:90%;max-width:300px}
.calendar-popup.show{display:block}
.calendar-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.calendar-nav{background:var(--input);border:none;border-radius:6px;width:36px;height:36px;color:var(--text);cursor:pointer;font-size:1.1rem}
.calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:.25rem}
.calendar-weekday{text-align:center;font-size:.65rem;color:var(--muted);padding:.2rem}
.calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:var(--input);border:none;border-radius:6px;color:var(--text);font-size:.8rem;cursor:pointer}
.calendar-day.other{color:var(--muted);opacity:.4}
.calendar-day.today{border:2px solid var(--cyan)}
.calendar-day.selected{background:linear-gradient(135deg,var(--cyan),var(--purple));color:var(--bg);font-weight:600}
@media(max-width:600px){.header-content{flex-direction:column;align-items:stretch}.form-grid{grid-template-columns:1fr}.stats{grid-template-columns:repeat(3,1fr)}}
    </style>
</head>
<body>
    <div class="offline-banner" id="offlineBanner">üì¥ Offline Mode</div>
    <div class="sync-banner" id="syncBanner"><div class="spinner"></div> Syncing...</div>
    <div class="loading" id="loading"><div class="loading-logo">WB</div><div style="color:var(--muted)">Loading...</div></div>
    <div id="app" style="display:none">
        <header class="header">
            <div class="header-content">
                <div class="logo"><div class="logo-icon">WB</div><div><div class="logo-text">WackyBuds CFR</div><div class="logo-sub">v3.8.1 ‚Ä¢ NO DUPLICATES</div></div></div>
                <div class="clock"><div class="clock-time" id="clock">--:--:--</div><div class="clock-date" id="date">Loading...</div></div>
                <div class="status"><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span><span class="badge" id="pendingBadge" style="display:none">0</span></div>
            </div>
        </header>
        <main class="main">
            <div class="tabs">
                <button class="tab active" data-tab="entry">üìù Entry</button>
                <button class="tab" data-tab="report">üìä Report</button>
                <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>
            <div id="entry" class="tab-content active">
                <form id="entryForm">
                    <div class="card">
                        <div class="card-head"><div class="card-title">üìÖ Basic Info</div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label req">Date</label><input type="text" class="form-input" id="entryDate" readonly placeholder="Select date"><span class="form-err" id="dateErr">Required</span></div>
                            <div class="form-group"><label class="form-label">Day</label><input type="text" class="form-input" id="entryDay" readonly style="background:var(--bg2)"></div>
                            <div class="form-group"><label class="form-label req">Shift</label><select class="form-select" id="entryShift"><option value="">Select</option><option value="12:00PM - 8:00PM">12:00PM - 8:00PM</option><option value="8:00PM - 4:00AM">8:00PM - 4:00AM</option><option value="4:00AM - 12:00PM">4:00AM - 12:00PM</option></select><span class="form-err" id="shiftErr">Required</span></div>
                            <div class="form-group"><label class="form-label req">Loader Name</label><input type="text" class="form-input" id="dutyName" placeholder="Enter name"><span class="form-err" id="nameErr">Required</span></div>
                        </div>
                    </div>
                    <div class="stats">
                        <div class="stat"><div class="stat-label">CFR</div><div class="stat-val" id="statCFR">‚Ç±0.00</div></div>
                        <div class="stat"><div class="stat-label">Remit</div><div class="stat-val green" id="statRemit">‚Ç±0.00</div></div>
                        <div class="stat"><div class="stat-label">Unremit</div><div class="stat-val yellow" id="statUnremit">‚Ç±0.00</div></div>
                    </div>
                    <div class="card">
                        <div class="card-head"><div class="card-title">üí∞ Active Chips</div><div class="card-total" id="activeTotal">‚Ç±0.00</div></div>
                        <div class="entry-list" id="activeList"></div>
                        <button type="button" class="btn-add" onclick="addRow('active')">+ Add</button>
                    </div>
                    <div class="card">
                        <div class="card-head"><div class="card-title">üé∞ End Chips</div><div class="card-total" id="endTotal">‚Ç±0.00</div></div>
                        <div class="entry-list" id="endList"><div class="entry-row"><input type="text" inputmode="decimal" placeholder="Amount" class="entry-input amt" onkeyup="fmtInput(this)" oninput="calc()"><input type="text" class="entry-input" value="End Chips"><button type="button" class="btn-remove" onclick="delRow(this)">√ó</button></div></div>
                        <button type="button" class="btn-add" onclick="addRow('end')">+ Add</button>
                    </div>
                    <div class="card">
                        <div class="card-head"><div class="card-title">üí∏ Remittances</div><div class="card-total" id="remitTotal">‚Ç±0.00</div></div>
                        <div class="entry-list" id="remitList"><div class="entry-row"><input type="text" inputmode="decimal" placeholder="Amount" class="entry-input amt" onkeyup="fmtInput(this)" oninput="calc()"><input type="text" class="entry-input" value="Remittance"><button type="button" class="btn-remove" onclick="delRow(this)">√ó</button></div></div>
                        <button type="button" class="btn-add" onclick="addRow('remit')">+ Add</button>
                    </div>
                    <div class="card">
                        <div class="card-head"><div class="card-title">üìã Details</div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Bank Fee</label><input type="text" inputmode="decimal" class="form-input" id="bankFee" value="0" onkeyup="fmtInput(this)" oninput="calc()"></div>
                            <div class="form-group"><label class="form-label">Salary</label><input type="text" inputmode="decimal" class="form-input" id="salary" value="0" onkeyup="fmtInput(this)" oninput="calc()"></div>
                            <div class="form-group" style="grid-column:span 2"><label class="form-label">Remarks</label><input type="text" class="form-input" id="remarks" placeholder="DONE, PENDING, etc."></div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-row"><span class="calc-label">CFR (Active - End)</span><span class="calc-val" id="calcCFR">‚Ç±0.00</span></div>
                            <div class="calc-row"><span class="calc-label">Total Remit + Salary</span><span class="calc-val" id="calcRemit">‚Ç±0.00</span></div>
                            <div class="calc-row"><span class="calc-label">Unremitted</span><span class="calc-val big" id="calcUnremit">‚Ç±0.00</span></div>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top:1rem"><button type="submit" class="btn btn-primary" id="submitBtn">üíæ Save Entry</button><button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear</button></div>
                </form>
            </div>
            <div id="report" class="tab-content">
                <div class="card">
                    <div class="card-head"><div class="card-title">üìä Report</div><div class="btn-group"><button class="btn btn-secondary" onclick="loadData()">üîÑ</button></div></div>
                    <div class="filter-row">
                        <div class="form-group"><label class="form-label">Loader</label><select class="form-select" id="filterLoader" onchange="filterData()" style="min-width:120px"><option value="">All</option></select></div>
                        <div class="form-group"><label class="form-label">Start</label><input type="text" class="form-input" id="filterStart" readonly placeholder="Start" style="min-width:110px"></div>
                        <div class="form-group"><label class="form-label">End</label><input type="text" class="form-input" id="filterEnd" readonly placeholder="End" style="min-width:110px"></div>
                        <button class="btn btn-secondary" onclick="clearFilter()">‚úï</button>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th>Date</th><th>Shift</th><th>Loader</th><th>Active</th><th>End</th><th>CFR</th><th>Remit</th><th>Fee</th><th>Unremit</th><th>Status</th><th></th></tr></thead><tbody id="reportBody"><tr><td colspan="11" style="text-align:center;color:var(--muted);padding:2rem">No data</td></tr></tbody></table></div>
                </div>
            </div>
            <div id="settings" class="tab-content">
                <div class="card">
                    <div class="card-head"><div class="card-title">‚öôÔ∏è Settings</div></div>
                    <div class="settings-group">
                        <div class="settings-title">üîó Google Sheets</div>
                        <div class="form-group"><label class="form-label">Script URL</label><input type="url" class="form-input" id="scriptUrl" placeholder="https://script.google.com/..."></div>
                        <div class="btn-group" style="margin-top:.75rem"><button class="btn btn-primary" onclick="saveUrl()">üíæ Save</button><button class="btn btn-secondary" onclick="testUrl()">üîó Test</button></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-title">üì¥ Offline Data</div>
                        <div class="settings-item"><div><strong>Pending Entries</strong><div style="font-size:.75rem;color:var(--muted)" id="pendingCount">0 entries</div></div><button class="btn btn-warning" onclick="syncNow()">üîÑ Sync</button></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-title">üì± App</div>
                        <div class="settings-item"><div><strong>Version</strong><div style="font-size:.75rem;color:var(--muted)">3.8.1 No Duplicates</div></div></div>
                        <div class="settings-item"><div><strong>Hard Refresh</strong><div style="font-size:.75rem;color:var(--muted)">Clear cache & reload</div></div><button class="btn btn-green" onclick="hardRefresh()">üîÉ</button></div>
                    </div>
                </div>
            </div>
        </main>
        <div class="toast-container" id="toasts"></div>
    </div>
    <div class="calendar-overlay" id="calOverlay"></div>
    <div class="calendar-popup" id="calPopup">
        <div class="calendar-head"><button type="button" class="calendar-nav" id="calPrev">‚Äπ</button><span id="calTitle"></span><button type="button" class="calendar-nav" id="calNext">‚Ä∫</button></div>
        <div class="calendar-weekdays"><div class="calendar-weekday">Su</div><div class="calendar-weekday">Mo</div><div class="calendar-weekday">Tu</div><div class="calendar-weekday">We</div><div class="calendar-weekday">Th</div><div class="calendar-weekday">Fr</div><div class="calendar-weekday">Sa</div></div>
        <div class="calendar-days" id="calDays"></div>
    </div>
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-head"><div class="modal-title">‚úèÔ∏è Edit Entry</div><button class="modal-close" onclick="closeEdit()">√ó</button></div>
            <form id="editForm">
                <input type="hidden" id="editIdx">
                <div class="form-grid" style="margin-bottom:1rem">
                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="editDate"></div>
                    <div class="form-group"><label class="form-label">Shift</label><select class="form-select" id="editShift"><option value="12:00PM - 8:00PM">12:00PM - 8:00PM</option><option value="8:00PM - 4:00AM">8:00PM - 4:00AM</option><option value="4:00AM - 12:00PM">4:00AM - 12:00PM</option></select></div>
                    <div class="form-group"><label class="form-label">Loader</label><input type="text" class="form-input" id="editLoader"></div>
                    <div class="form-group"><label class="form-label">Active</label><input type="text" inputmode="decimal" class="form-input" id="editActive" onkeyup="fmtInput(this)" oninput="recalcEdit()"></div>
                    <div class="form-group"><label class="form-label">End</label><input type="text" inputmode="decimal" class="form-input" id="editEnd" onkeyup="fmtInput(this)" oninput="recalcEdit()"></div>
                    <div class="form-group"><label class="form-label">CFR</label><input type="text" class="form-input" id="editCFR" readonly style="color:var(--cyan)"></div>
                    <div class="form-group"><label class="form-label">Remit</label><input type="text" inputmode="decimal" class="form-input" id="editRemit" onkeyup="fmtInput(this)" oninput="recalcEdit()"></div>
                    <div class="form-group"><label class="form-label">Fee</label><input type="text" inputmode="decimal" class="form-input" id="editFee" onkeyup="fmtInput(this)"></div>
                    <div class="form-group"><label class="form-label">Salary</label><input type="text" inputmode="decimal" class="form-input" id="editSalary" onkeyup="fmtInput(this)" oninput="recalcEdit()"></div>
                    <div class="form-group"><label class="form-label">Unremit</label><input type="text" class="form-input" id="editUnremit" readonly style="color:var(--yellow)"></div>
                    <div class="form-group" style="grid-column:span 2"><label class="form-label">Remarks</label><input type="text" class="form-input" id="editRemarks"></div>
                </div>
                <div class="btn-group"><button type="submit" class="btn btn-primary">üíæ Save</button><button type="button" class="btn btn-danger" onclick="delEntry()">üóëÔ∏è Delete</button></div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="delModal">
        <div class="modal">
            <div class="modal-head"><div class="modal-title">‚ö†Ô∏è Delete Entry?</div><button class="modal-close" onclick="closeDel()">√ó</button></div>
            <p style="margin-bottom:1rem;color:var(--muted)">This cannot be undone.</p>
            <div class="btn-group"><button class="btn btn-danger" onclick="confirmDel()">üóëÔ∏è Delete</button><button class="btn btn-secondary" onclick="closeDel()">Cancel</button></div>
        </div>
    </div>
<script>
// ===== CONFIG =====
const CFG={url:localStorage.getItem('cfr_url')||'',tz:'Asia/Manila'};
let data=[],filtered=[],lastEnd=parseFloat(localStorage.getItem('cfr_last_end'))||0;
let calDate=new Date(),selDate=new Date(),calTarget=null;
let editIdx=null,editEntry=null,isOnline=navigator.onLine,isSyncing=false,isSubmitting=false;
const SHIFT={'12:00PM - 8:00PM':1,'8:00PM - 4:00AM':2,'4:00AM - 12:00PM':3};
const STORE={pending:'cfr_pending',cache:'cfr_cache',synced:'cfr_synced_ids'};

// ===== UTILS =====
const $=id=>document.getElementById(id);
const fmtNum=(v,d=2)=>(parseFloat(v)||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});
const fmtCur=(v,d=2)=>'‚Ç±'+fmtNum(v,d);
const parseN=v=>parseFloat(String(v).replace(/,/g,''))||0;
const fmtVal=v=>v?parseFloat(v).toLocaleString('en-US'):'';
function fmtInput(el){let v=el.value.replace(/[^0-9.]/g,''),p=v.split('.');if(p[0])p[0]=parseInt(p[0]||0).toLocaleString('en-US');el.value=p.join('.');}
const fmtTime=(d=new Date())=>d.toLocaleTimeString('en-US',{timeZone:CFG.tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
const fmtDateFull=(d=new Date())=>d.toLocaleDateString('en-US',{timeZone:CFG.tz,weekday:'long',month:'long',day:'numeric',year:'numeric'});
const fmtDateShort=d=>d?new Date(d).toLocaleDateString('en-US',{timeZone:CFG.tz,month:'short',day:'numeric',year:'numeric'}):'-';
const getDateStr=(d=new Date())=>{const p=new Intl.DateTimeFormat('en-CA',{timeZone:CFG.tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);return `${p.find(x=>x.type==='year').value}-${p.find(x=>x.type==='month').value}-${p.find(x=>x.type==='day').value}`;};
function toast(msg,type='success'){const c=$('toasts'),t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${type==='success'?'‚úÖ':type==='warning'?'‚ö†Ô∏è':'‚ùå'}</span><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),200);},2500);}
const genId=()=>Date.now().toString(36)+Math.random().toString(36).substr(2,5);

// ===== PENDING STORAGE - WITH DUPLICATE PREVENTION =====
const getPending=()=>{try{return JSON.parse(localStorage.getItem(STORE.pending))||[];}catch{return[];}};
const savePending=arr=>{localStorage.setItem(STORE.pending,JSON.stringify(arr));updPendingUI();};
const getSyncedIds=()=>{try{return JSON.parse(localStorage.getItem(STORE.synced))||[];}catch{return[];}};
const addSyncedId=id=>{const ids=getSyncedIds();if(!ids.includes(id)){ids.push(id);localStorage.setItem(STORE.synced,JSON.stringify(ids.slice(-100)));}};
const isSynced=id=>getSyncedIds().includes(id);

function addPending(entry){
    const arr=getPending();
    entry.uniqueId=genId();
    entry.pendingId=Date.now();
    entry.pending=true;
    arr.push(entry);
    savePending(arr);
}
const delPending=id=>{savePending(getPending().filter(e=>e.pendingId!==id));};
const getCache=()=>{try{return JSON.parse(localStorage.getItem(STORE.cache))||[];}catch{return[];}};
const saveCache=arr=>localStorage.setItem(STORE.cache,JSON.stringify(arr));

function updPendingUI(){const p=getPending(),b=$('pendingBadge'),c=$('pendingCount');if(p.length>0){b.textContent=p.length;b.style.display='inline';}else{b.style.display='none';}if(c)c.textContent=`${p.length} entries`;}

// ===== SEND TO SERVER - SINGLE METHOD ONLY =====
async function send(d){
    if(!CFG.url||!isOnline)return false;
    try{
        const ctrl=new AbortController();
        const timeout=setTimeout(()=>ctrl.abort(),10000);
        const res=await fetch(CFG.url,{
            method:'POST',
            headers:{'Content-Type':'text/plain'},
            body:JSON.stringify(d),
            signal:ctrl.signal
        });
        clearTimeout(timeout);
        return res.ok;
    }catch(e){
        console.log('Send error:',e);
        return false;
    }
}

// ===== SYNC PENDING - NO DUPLICATES =====
async function syncNow(){
    if(!CFG.url||!isOnline||isSyncing)return;
    const pending=getPending();
    if(pending.length===0)return;
    
    isSyncing=true;
    $('syncBanner').classList.add('show');
    $('statusDot').className='status-dot syncing';
    
    let synced=0;
    for(const e of pending){
        // Skip if already synced
        if(e.uniqueId&&isSynced(e.uniqueId)){
            delPending(e.pendingId);
            synced++;
            continue;
        }
        
        const success=await send(e);
        if(success){
            if(e.uniqueId)addSyncedId(e.uniqueId);
            delPending(e.pendingId);
            synced++;
        }else{
            break; // Stop on first failure
        }
    }
    
    isSyncing=false;
    $('syncBanner').classList.remove('show');
    updStatus();
    
    const rem=getPending();
    if(rem.length===0){
        if(synced>0)toast('Synced!');
        loadData();
    }else{
        toast(`${rem.length} pending`,'warning');
    }
}

// ===== ONLINE STATUS =====
function updStatus(){
    isOnline=navigator.onLine;
    $('offlineBanner').classList.toggle('show',!isOnline);
    const dot=$('statusDot'),txt=$('statusText');
    dot.className='status-dot';
    if(!isOnline){dot.classList.add('off');txt.textContent='Offline';}
    else if(CFG.url){dot.classList.add('on');txt.textContent='Online';}
    else{txt.textContent='Ready';}
}

// Auto sync when coming online
let syncTimeout=null;
function onOnline(){
    updStatus();
    // Debounce sync to prevent multiple calls
    if(syncTimeout)clearTimeout(syncTimeout);
    syncTimeout=setTimeout(()=>{if(isOnline&&CFG.url)syncNow();},1000);
}

// ===== CLOCK =====
function updClock(){$('clock').textContent=fmtTime();$('date').textContent=fmtDateFull();}

// ===== STARTING CHIPS =====
function updStarting(){
    const list=$('activeList'),ex=list.querySelector('.starting');
    if(lastEnd>0){
        if(ex)ex.querySelector('.amt').value=fmtVal(lastEnd);
        else{const r=document.createElement('div');r.className='entry-row starting';r.innerHTML=`<input type="text" inputmode="decimal" class="entry-input amt" value="${fmtVal(lastEnd)}" onkeyup="fmtInput(this)" oninput="calc()"><input type="text" class="entry-input" value="Starting (Prev End)"><button type="button" class="btn-remove" onclick="delRow(this)">√ó</button>`;list.insertBefore(r,list.firstChild);}
    }
    calc();
}
const setLastEnd=v=>{lastEnd=parseFloat(v)||0;localStorage.setItem('cfr_last_end',lastEnd);};

// ===== ROWS =====
function addRow(type){
    const listId=type==='active'?'activeList':type==='end'?'endList':'remitList';
    const defRemark=type==='end'?'End Chips':type==='remit'?'Remittance':'';
    const list=$(listId),r=document.createElement('div');
    r.className='entry-row';
    r.innerHTML=`<input type="text" inputmode="decimal" placeholder="Amount" class="entry-input amt" onkeyup="fmtInput(this)" oninput="calc()"><input type="text" class="entry-input" value="${defRemark}"><button type="button" class="btn-remove" onclick="delRow(this)">√ó</button>`;
    list.appendChild(r);r.querySelector('.amt').focus();
}
function delRow(btn){const r=btn.closest('.entry-row');r.remove();calc();}
const getSum=id=>{let s=0;$(id).querySelectorAll('.amt').forEach(i=>s+=parseN(i.value));return s;};
const getDetails=id=>{const arr=[];$(id).querySelectorAll('.entry-row').forEach(r=>{const a=parseN(r.querySelector('.amt')?.value),rm=r.querySelectorAll('.entry-input')[1]?.value||'';if(a>0||rm)arr.push({amount:a,remarks:rm});});return arr;};

// ===== CALCULATIONS =====
function calc(){
    const active=getSum('activeList'),end=getSum('endList'),remit=getSum('remitList'),sal=parseN($('salary').value);
    const cfr=active-end,totalRemit=remit+sal,unremit=totalRemit-cfr;
    $('activeTotal').textContent=fmtCur(active);
    $('endTotal').textContent=fmtCur(end);
    $('remitTotal').textContent=fmtCur(remit);
    $('calcCFR').textContent=fmtCur(cfr);
    $('calcRemit').textContent=fmtCur(totalRemit);
    const u=$('calcUnremit');u.textContent=fmtCur(unremit);u.classList.toggle('neg',unremit<0);
    $('statCFR').textContent=fmtCur(cfr);
    $('statRemit').textContent=fmtCur(totalRemit);
    $('statUnremit').textContent=fmtCur(unremit);
}

// ===== CALENDAR =====
function initCal(){
    $('entryDate').onclick=()=>{calTarget='entry';calDate=new Date(selDate);$('calPopup').classList.add('show');$('calOverlay').classList.add('show');renderCal();};
    $('filterStart').onclick=()=>{calTarget='start';$('calPopup').classList.add('show');$('calOverlay').classList.add('show');renderCal();};
    $('filterEnd').onclick=()=>{calTarget='end';$('calPopup').classList.add('show');$('calOverlay').classList.add('show');renderCal();};
    $('calOverlay').onclick=()=>{$('calPopup').classList.remove('show');$('calOverlay').classList.remove('show');};
    $('calPrev').onclick=()=>{calDate.setMonth(calDate.getMonth()-1);renderCal();};
    $('calNext').onclick=()=>{calDate.setMonth(calDate.getMonth()+1);renderCal();};
}
function renderCal(){
    const y=calDate.getFullYear(),m=calDate.getMonth();
    $('calTitle').textContent=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]+' '+y;
    const first=new Date(y,m,1).getDay(),days=new Date(y,m+1,0).getDate(),prev=new Date(y,m,0).getDate();
    const c=$('calDays');c.innerHTML='';
    const today=getDateStr();
    for(let i=first-1;i>=0;i--){const b=document.createElement('button');b.type='button';b.className='calendar-day other';b.textContent=prev-i;c.appendChild(b);}
    for(let d=1;d<=days;d++){
        const dt=new Date(y,m,d),ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const b=document.createElement('button');b.type='button';b.className='calendar-day';b.textContent=d;
        if(ds===today)b.classList.add('today');
        if(selDate&&dt.toDateString()===selDate.toDateString())b.classList.add('selected');
        b.onclick=()=>pickDate(dt);
        c.appendChild(b);
    }
    for(let d=1;c.children.length<42;d++){const b=document.createElement('button');b.type='button';b.className='calendar-day other';b.textContent=d;c.appendChild(b);}
}
function pickDate(d){
    if(calTarget==='entry'){
        selDate=d;calDate=new Date(d);
        $('entryDate').value=d.toLocaleDateString('en-US',{timeZone:CFG.tz,weekday:'short',year:'numeric',month:'short',day:'numeric'});
        $('entryDate').dataset.value=d.toLocaleDateString('en-CA');
        $('entryDay').value=['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'][d.getDay()];
    }else if(calTarget==='start'){
        $('filterStart').value=fmtDateShort(d);$('filterStart').dataset.value=d.toISOString();
    }else if(calTarget==='end'){
        $('filterEnd').value=fmtDateShort(d);$('filterEnd').dataset.value=d.toISOString();
    }
    $('calPopup').classList.remove('show');$('calOverlay').classList.remove('show');
    if(calTarget!=='entry')filterData();
}
function clearFilter(){$('filterStart').value='';$('filterEnd').value='';$('filterStart').dataset.value='';$('filterEnd').dataset.value='';filterData();}

// ===== FORM VALIDATION =====
function validate(){
    let ok=true;
    [{id:'entryDate',err:'dateErr',val:$('entryDate').dataset.value},{id:'entryShift',err:'shiftErr',val:$('entryShift').value},{id:'dutyName',err:'nameErr',val:$('dutyName').value.trim()}].forEach(c=>{
        const el=$(c.id),er=$(c.err);
        if(!c.val){er.classList.add('show');el.classList.add('err');ok=false;}
        else{er.classList.remove('show');el.classList.remove('err');}
    });
    return ok;
}

// ===== FORM SUBMIT - NO DUPLICATES =====
$('entryForm').onsubmit=async e=>{
    e.preventDefault();
    if(!validate()){toast('Fill required fields','error');return;}
    const btn=$('submitBtn');
    if(btn.disabled||isSubmitting)return;
    isSubmitting=true;btn.disabled=true;btn.innerHTML='<div class="spinner"></div>';
    
    const activeTotal=getSum('activeList'),endTotal=getSum('endList');
    const entry={
        action:'addEntry',
        date:$('entryDate').dataset.value,
        day:$('entryDay').value,
        shift:$('entryShift').value,
        dutyName:$('dutyName').value,
        activeChips:getDetails('activeList'),
        activeChipsTotal:activeTotal,
        endChips:getDetails('endList'),
        endChipsTotal:endTotal,
        remittances:getDetails('remitList'),
        remittanceTotal:getSum('remitList'),
        bankFee:parseN($('bankFee').value),
        salary:parseN($('salary').value),
        remarks:$('remarks').value,
        timestamp:new Date().toISOString()
    };
    entry.cfr=entry.activeChipsTotal-entry.endChipsTotal;
    entry.totalRemittances=entry.remittanceTotal+entry.salary;
    entry.unremitted=entry.totalRemittances-entry.cfr;
    
    setLastEnd(endTotal);
    addPending(entry);
    toast('Saved!');
    clearForm();
    
    setTimeout(()=>{btn.innerHTML='üíæ Save Entry';btn.disabled=false;isSubmitting=false;},1000);
    
    // Only sync after delay, don't trigger immediately
    if(isOnline&&CFG.url){
        setTimeout(()=>{if(!isSyncing)syncNow();},500);
    }
};

function clearForm(){
    pickDate(new Date());
    $('dutyName').value='';$('entryShift').value='';$('bankFee').value='0';$('salary').value='0';$('remarks').value='';
    document.querySelectorAll('.form-err').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('.form-input.err').forEach(e=>e.classList.remove('err'));
    ['endList','remitList'].forEach((id,i)=>{
        const list=$(id),def=i===0?'End Chips':'Remittance';
        list.querySelectorAll('.entry-row').forEach((r,j)=>{if(j===0){r.querySelector('.amt').value='';r.querySelectorAll('.entry-input')[1].value=def;}else r.remove();});
    });
    $('activeList').querySelectorAll('.entry-row:not(.starting)').forEach(r=>r.remove());
    updStarting();
}

// ===== TABS =====
document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');$(t.dataset.tab).classList.add('active');
        if(t.dataset.tab==='report')loadData();
    };
});

// ===== LOAD DATA - DEDUPLICATE =====
function loadCached(){
    const cache=getCache(),pending=getPending();
    // Merge without duplicates
    const pendingIds=pending.map(p=>p.uniqueId).filter(Boolean);
    data=[...cache,...pending.map(p=>({...p,pending:true}))];
    filterData();updLoaderFilter();
}

async function loadData(){
    if(!CFG.url){loadCached();return;}
    if(!isOnline){loadCached();toast('Offline - cached','warning');return;}
    try{
        const res=await fetch(`${CFG.url}?action=getData&_=${Date.now()}`);
        const json=await res.json();
        if(json.success){
            saveCache(json.entries||[]);
            const pending=getPending();
            // Don't show pending entries that might already be synced
            const serverData=json.entries||[];
            data=[...serverData,...pending.filter(p=>!isSynced(p.uniqueId)).map(p=>({...p,pending:true}))];
            if(data.length>0){
                const sorted=[...data].filter(e=>!e.pending).sort((a,b)=>new Date(b.date)-new Date(a.date)||(SHIFT[b.shift]||0)-(SHIFT[a.shift]||0));
                if(sorted[0]?.endChipsTotal!==undefined){setLastEnd(sorted[0].endChipsTotal);updStarting();}
            }
            filterData();updLoaderFilter();
        }
    }catch(err){console.error(err);loadCached();}
}

function updLoaderFilter(){
    const sel=$('filterLoader'),loaders=[...new Set(data.map(e=>e.dutyName).filter(Boolean))];
    sel.innerHTML='<option value="">All</option>'+loaders.map(l=>`<option value="${l}">${l}</option>`).join('');
}

function filterData(){
    let d=data;
    const loader=$('filterLoader').value;if(loader)d=d.filter(e=>e.dutyName===loader);
    const start=$('filterStart').dataset.value,end=$('filterEnd').dataset.value;
    if(start&&end){const s=new Date(start),e=new Date(end);s.setHours(0,0,0,0);e.setHours(23,59,59,999);d=d.filter(x=>{const dt=new Date(x.date);return dt>=s&&dt<=e;});}
    else if(start||end){const fd=new Date(start||end);d=d.filter(x=>new Date(x.date).toDateString()===fd.toDateString());}
    d.sort((a,b)=>new Date(b.date)-new Date(a.date)||(SHIFT[b.shift]||0)-(SHIFT[a.shift]||0));
    filtered=d;renderTable();
}

function renderTable(){
    const tb=$('reportBody');
    if(filtered.length===0){tb.innerHTML='<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:2rem">No data</td></tr>';return;}
    let html='',tot={active:0,end:0,cfr:0,remit:0,unremit:0};
    filtered.forEach(e=>{
        tot.active+=e.activeChipsTotal||0;tot.end+=e.endChipsTotal||0;tot.cfr+=e.cfr||0;tot.remit+=e.totalRemittances||0;tot.unremit+=e.unremitted||0;
        const pend=e.pending;
        html+=`<tr class="${pend?'pending':''}"><td>${fmtDateShort(e.date)}${pend?' ‚è≥':''}</td><td style="font-size:.7rem">${e.shift||'-'}</td><td>${e.dutyName||'-'}</td><td>${fmtCur(e.activeChipsTotal)}</td><td>${fmtCur(e.endChipsTotal)}</td><td>${fmtCur(e.cfr)}</td><td>${fmtCur(e.totalRemittances)}</td><td>${fmtCur(e.bankFee)}</td><td style="color:${(e.unremitted||0)<0?'var(--red)':'var(--yellow)'}">${fmtCur(e.unremitted)}</td><td>${pend?'‚è≥':(e.remarks||'-')}</td><td>${!pend&&e.rowIndex?`<button class="btn btn-secondary" style="padding:.4rem;font-size:.7rem" onclick="openEdit(${e.rowIndex})">‚úèÔ∏è</button>`:''}</td></tr>`;
    });
    html+=`<tr class="table-foot"><td colspan="3" style="text-align:right">TOTAL:</td><td>${fmtCur(tot.active)}</td><td>${fmtCur(tot.end)}</td><td>${fmtCur(tot.cfr)}</td><td>${fmtCur(tot.remit)}</td><td>-</td><td style="color:${tot.unremit<0?'var(--red)':'var(--cyan)'}">${fmtCur(tot.unremit)}</td><td colspan="2"></td></tr>`;
    tb.innerHTML=html;
}

// ===== EDIT =====
$('editForm').onsubmit=async e=>{
    e.preventDefault();
    if(!editIdx)return;
    const d={action:'updateEntry',rowIndex:editIdx,date:$('editDate').value,shift:$('editShift').value,dutyName:$('editLoader').value,activeChipsTotal:parseN($('editActive').value),endChipsTotal:parseN($('editEnd').value),cfr:parseN($('editCFR').value),remittanceTotal:parseN($('editRemit').value),bankFee:parseN($('editFee').value),salary:parseN($('editSalary').value),totalRemittances:parseN($('editRemit').value)+parseN($('editSalary').value),unremitted:parseN($('editUnremit').value),remarks:$('editRemarks').value};
    const idx=data.findIndex(x=>x.rowIndex===editIdx);
    if(idx!==-1)Object.assign(data[idx],d);
    filterData();toast('Updated!');closeEdit();
    if(isOnline&&CFG.url){send(d);setTimeout(loadData,1000);}
};
function openEdit(rowIndex){
    editIdx=rowIndex;editEntry=data.find(e=>e.rowIndex===rowIndex);
    if(!editEntry){toast('Not found','error');return;}
    $('editIdx').value=rowIndex;$('editDate').value=editEntry.date;$('editShift').value=editEntry.shift||'';$('editLoader').value=editEntry.dutyName||'';
    $('editActive').value=fmtVal(editEntry.activeChipsTotal);$('editEnd').value=fmtVal(editEntry.endChipsTotal);$('editCFR').value=fmtVal(editEntry.cfr);
    $('editRemit').value=fmtVal(editEntry.remittanceTotal);$('editFee').value=fmtVal(editEntry.bankFee);$('editSalary').value=fmtVal(editEntry.salary);
    $('editUnremit').value=fmtVal(editEntry.unremitted);$('editRemarks').value=editEntry.remarks||'';
    $('editModal').classList.add('show');
}
function recalcEdit(){
    const a=parseN($('editActive').value),e=parseN($('editEnd').value),r=parseN($('editRemit').value),s=parseN($('editSalary').value);
    $('editCFR').value=fmtVal(a-e);$('editUnremit').value=fmtVal((r+s)-(a-e));
}
function closeEdit(){editIdx=null;editEntry=null;$('editModal').classList.remove('show');}
function delEntry(){$('editModal').classList.remove('show');$('delModal').classList.add('show');}
function closeDel(){editIdx=null;editEntry=null;$('delModal').classList.remove('show');}
function confirmDel(){
    if(!editIdx)return;
    const rowToDel=editIdx;
    data=data.filter(e=>e.rowIndex!==rowToDel);
    filterData();toast('Deleted!');closeDel();
    if(isOnline&&CFG.url){send({action:'deleteEntry',rowIndex:rowToDel});setTimeout(loadData,1000);}
}

// ===== SETTINGS =====
function saveUrl(){const u=$('scriptUrl').value.trim();if(u){CFG.url=u;localStorage.setItem('cfr_url',u);toast('Saved!');loadData();}else toast('Enter URL','error');}
async function testUrl(){
    const u=$('scriptUrl').value.trim();
    if(!u){toast('Enter URL','error');return;}
    if(!isOnline){toast('Offline','error');return;}
    try{const res=await fetch(`${u}?action=test&_=${Date.now()}`);const json=await res.json();toast(json.success?'Connected!':'Failed',json.success?'success':'error');}
    catch{toast('Failed','error');}
}
function hardRefresh(){toast('Refreshing...');setTimeout(()=>location.reload(true),300);}

// ===== PWA =====
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
    updClock();setInterval(updClock,1000);
    window.addEventListener('online',onOnline);
    window.addEventListener('offline',updStatus);
    updStatus();updPendingUI();
    initCal();pickDate(new Date());updStarting();
    if(CFG.url){$('scriptUrl').value=CFG.url;loadData();}else loadCached();
    setTimeout(()=>{$('loading').style.display='none';$('app').style.display='block';},300);
});
</script>
</body>
</html>
